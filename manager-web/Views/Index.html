<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Counters Sampler</title>
	</head>
	<body>
		<div id="jit-graphs">
			<h1>JIT</h1>
			<hr/>
		</div>
		<div style="clear:both"/>

		<div id="gc-graphs">
			<h1>GC</h1>
			<hr/>
		</div>
		<div style="clear:both"/>

		<div id="metadata-graphs">
			<h1>Metadata</h1>
			<hr/>
		</div>
		<div style="clear:both"/>

		<div id="generics-graphs">
			<h1>Generics</h1>
			<hr/>
		</div>
		<div style="clear:both"/>

		<div id="security-graphs">
			<h1>Security</h1>
			<hr/>
		</div>
		<div style="clear:both"/>

		<div id="graphs">
			<h1>Other</h1>
			<hr/>
		</div>

		<script type="text/javascript" src="https://www.google.com/jsapi"></script>
		<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.0.min.js"></script>
		<script type="text/javascript">
			google.load('visualization', '1.0', {'packages':['corechart']});
			google.setOnLoadCallback(main);

			function main() {
				var names = [
					{name: 'Dynamic code allocs', category: 0},
					{name: 'Dynamic code bytes', category: 0},
					{name: 'Dynamic code frees', category: 0},
					{name: 'Unwind info size', category: 0},
					{name: 'Calls to trampolines', category: 0},
					{name: 'JIT trampolines', category: 0},
					{name: 'Unbox trampolines', category: 0},
					{name: 'Static rgctx trampolines', category: 0},
					{name: 'Async JIT info size', category: 0},
					{name: 'Max native code in a domain', category: 0},
					{name: 'Max code space allocated in a domain', category: 0},
					{name: 'Total code space allocated', category: 0},
					{name: 'Hazardous pointers', category: 0},
					{name: 'Minor fragment clear', category: 1},
					{name: 'Minor pinning', category: 1},
					{name: 'Minor scan remembered set', category: 1},
					{name: 'Minor scan pinned', category: 1},
					{name: 'Minor scan registered roots', category: 1},
					{name: 'Minor scan thread data', category: 1},
					{name: 'Minor finish gray stack', category: 1},
					{name: 'Minor fragment creation', category: 1},
					{name: 'Major fragment clear', category: 1},
					{name: 'Major pinning', category: 1},
					{name: 'Major scan pinned', category: 1},
					{name: 'Major scan registered roots', category: 1},
					{name: 'Major scan thread data', category: 1},
					{name: 'Major scan alloc_pinned', category: 1},
					{name: 'Major scan finalized', category: 1},
					{name: 'Major scan big objects', category: 1},
					{name: 'Major finish gray stack', category: 1},
					{name: 'Major free big objects', category: 1},
					{name: 'Major LOS sweep', category: 1},
					{name: 'Major sweep', category: 1},
					{name: 'Major fragment creation', category: 1},
					{name: 'Number of pinned objects', category: 1},
					{name: '# major blocks allocated', category: 1},
					{name: '# major blocks freed', category: 1},
					{name: '# major blocks lazy swept', category: 1},
					{name: '# major objects evacuated', category: 1},
					{name: 'cardtable major scan time', category: 1},
					{name: 'cardtable los scan time', category: 1},
					{name: 'Inflated methods size', category: 3},
					{name: 'Inflated classes', category: 3},
					{name: 'Inflated classes size', category: 3},
					{name: 'MonoClass size', category: 2},
					{name: 'MonoClassExt size', category: 2},
					{name: 'Inflated signatures size', category: 3},
					{name: 'Memberref signature cache size', category: 2},
					{name: 'MonoMethod size', category: 2},
					{name: 'MonoMethodSignature size', category: 2},
					{name: 'GC Maps size', category: 1},
					{name: 'GC Call Sites size', category: 1},
					{name: 'GC Bitmaps size', category: 1},
					{name: 'GC Map struct size', category: 1},
					{name: 'GC Call Sites encoded using 8 bits', category: 1},
					{name: 'GC Call Sites encoded using 16 bits', category: 1},
					{name: 'GC Call Sites encoded using 32 bits', category: 1},
					{name: 'GC Map slots (all)', category: 1},
					{name: 'GC Map slots (ref)', category: 1},
					{name: 'GC Map slots (noref)', category: 1},
					{name: 'GC Map slots (pin)', category: 1},
					{name: 'GC TLS Data size', category: 1},
					{name: 'Stack space scanned (all)', category: 1},
					{name: 'Stack space scanned (native)', category: 1},
					{name: 'Stack space scanned (other)', category: 1},
					{name: 'Stack space scanned (using GC Maps)', category: 1},
					{name: 'Stack space scanned (precise)', category: 1},
					{name: 'Stack space scanned (pin)', category: 1},
					{name: 'Stack space scanned (pin registers)', category: 1},
					{name: 'Compiled methods', category: 0},
					{name: 'Methods from AOT', category: 0},
					{name: 'Methods JITted using mono JIT', category: 0},
					{name: 'Methods JITted using LLVM', category: 0},
					{name: 'Total time spent JITting (sec)', category: 0},
					{name: 'Basic blocks', category: 0},
					{name: 'Max basic blocks', category: 0},
					{name: 'Allocated vars', category: 0},
					{name: 'Code reallocs', category: 0},
					{name: 'Allocated code size', category: 0},
					{name: 'Inlineable methods', category: 0},
					{name: 'Inlined methods', category: 0},
					{name: 'Regvars', category: 0},
					{name: 'Locals stack size', category: 0},
					{name: 'Method cache lookups', category: 0},
					{name: 'Compiled CIL code size', category: 0},
					{name: 'Native code size', category: 0},
					{name: 'Aliases found', category: 0},
					{name: 'Aliases eliminated', category: 0},
					{name: 'Aliased loads eliminated', category: 0},
					{name: 'Aliased stores eliminated', category: 0},
					{name: 'Created object count', category: 1},
					{name: 'Minor GC collections', category: 1},
					{name: 'Major GC collections', category: 1},
					{name: 'Minor GC time', category: 1},
					{name: 'Major GC time', category: 1},
			    ];


				var data   = {};
				var charts = {};
				var min    = {};
				var max    = {};
				var lastTimestamp = 0;
				var firstTimestamp = 0;

				var TIMESTAMP_UNIT = Math.pow(10, 7);

				var MIN_TIMESTAMP_RANGE =  1 * 60 * TIMESTAMP_UNIT;
				var MAX_TIMESTAMP_RANGE = 10 * 60 * TIMESTAMP_UNIT;

				function AddCounter(counter) {
					var id = 'chart-' + counter.Index;

					switch (counter.Category) {
					case 0:
						$("#jit-graphs").append('<div style="float:left" id="' + id + '"></div>');
						break;
					case 1:
						$("#gc-graphs").append('<div style="float:left" id="' + id + '"></div>');
						break;
					case 2:
						$("#metadata-graphs").append('<div style="float:left" id="' + id + '"></div>');
						break;
					case 3:
						$("#generics-graphs").append('<div style="float:left" id="' + id + '"></div>');
						break;
					case 4:
						$("#security-graphs").append('<div style="float:left" id="' + id + '"></div>');
						break;
					default:
					case 0:
						$("#graphs").append('<div style="float:left" id="' + id + '"></div>');
						break;
					}

					charts[counter.Name] = new google.visualization.LineChart(document.getElementById(id));

					data[counter.Name] = new google.visualization.DataTable();
					data[counter.Name].addColumn('number', 'Timestamp');
					data[counter.Name].addColumn('number', counter.Name);

			        min[counter.Name] =  Number.MAX_VALUE;
			        max[counter.Name] = -Number.MAX_VALUE;

			        names.push(counter.Name);
				}

				function UpdateCountersPeriodically() {
					console.log("update " + new Date().getTime());

					$.ajax ("/counters", { data: { after: lastTimestamp, limit: MAX_TIMESTAMP_RANGE } })
					 .done(function (json) {
					 	$.each(json, function (timestamp, counters) {
					 		$.each(counters, function (i, counter) {
					 			if (data[counter.Name] === undefined)
					 				AddCounter(counter);

					 			var value = parseFloat(counter.Value);

								if (value < min[counter.Name])
									min[counter.Name] = value;

								if (value > max[counter.Name])
									max[counter.Name] = value;

								data[counter.Name].addRow([parseInt(timestamp) / TIMESTAMP_UNIT, value]);

								if (firstTimestamp > 0) {
									var min_ = Math.min(Math.max(lastTimestamp - MAX_TIMESTAMP_RANGE, firstTimestamp), lastTimestamp - MIN_TIMESTAMP_RANGE) / TIMESTAMP_UNIT

									for (var i = data[counter.Name].getNumberOfRows() - 1;  i >= 0; i--) {
										if (data[counter.Name].getFormattedValue(i, 0) < min_) {
											data[counter.Name].removeRow(i);
										}
									}
								}
							});

							if (firstTimestamp == 0)
								firstTimestamp = parseInt(timestamp);

					 		lastTimestamp = parseInt(timestamp);
					 	});

						if ($.isEmptyObject(json))
							setTimeout(UpdateCountersPeriodically, 1000);
						else
							setTimeout(UpdateCountersPeriodically, 0);
					});
				}

				function UpdateChartsPeriodically () {
					$.when
					 .apply($, $.map(names, function (v, i) {
					 	if (data[v] === undefined)
					 		return;

						var deferred = $.Deferred();
						setTimeout(function () {
							charts[v].draw(data[v], {title:     v,
				                                     width:     800,
				                                     height:    200,
				                                     lineWidth: 2,
				                                     pointSize: 0,
				                                     vAxis:     {minValue: Math.min(0, min[v]), maxValue: max[v] * 1.1},
				                                     legend:    {position: 'none'},});

					        deferred.resolve();
				        }, 0);
				        return deferred.promise();
					}))
					 .done(function () {
					 	setTimeout(UpdateChartsPeriodically, 1000);
					 });
				}

				UpdateCountersPeriodically();
				UpdateChartsPeriodically();
			}
		</script>
	</body>
</html>
